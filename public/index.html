<html>
	<head>
		<title>make stuff happen</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<style type="text/css">
		body {
			font-family: Monospace;
			background-color: #000;
			margin: 0px;
			overflow: hidden;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -o-user-select: none;
            user-select: none;
            cursor: pointer; 
		}
		#info {
			position: absolute;
			top: 30px; left: 150px; width: 800px;
			color: #000000;
			padding: 5px;
			font-family: Monospace;
			font-size: 13px;
			text-align: left;
			z-index:100;
		}
        #keys {
            position: absolute;
            right: 0;
            bottom: 0;
            background: #000;
            opacity: 0.5;
            color: #fff;
            padding: 10px;
            text-align: right;
        }
        #notice {
            position: absolute;
            top: 0;
            left: 40%;
            right: 40%;
            opacity: 0.5;
            color: #fff;
            background: #000;
            padding: 10px;
            text-align: center;
        }
		</style>
        <script type="text/javascript" src="/socket.io/socket.io.js"></script>
		<script type="text/javascript" src="Three.js"></script>
		<script type="text/javascript" src="Detector.js"></script>
		<script type="text/javascript" src="RequestAnimationFrame.js"></script>
		<script type="text/javascript" src="Stats.js"></script>
		<script type="text/javascript">
			var container
			  , stats
			  , camera
              , cameraTarget
			  , scene
              , projector
			  , renderer
			  , particles
              , mouse2D
			  , z = 500
              , ay = 0
              , ax = Math.PI/4
              , spinRadius = 1500
              , particlesPerBatch = 5
              , roundRobin = 0
              , lookVector = new THREE.Vector3(0, 0, 0)
              , input = {
                    left: false,
                    right: false,
                    up: false,
                    down: false,
                    shift: false,
                    mouseDown: false
                }
              , socket = io.connect();

			function init() {
				if (!Detector.webgl) {
					Detector.addGetWebGLMessage();
					return;
				}

                container = document.createElement('div');
				document.body.appendChild(container);

				camera = new THREE.CombinedCamera(window.innerWidth, window.innerHeight, 45, 1, 10000, -2000, 10000);
				camera.position.z = 1400;
                cameraTarget = new THREE.Vector3(0, 0, 0);
				scene = new THREE.Scene();
				//scene.fog = new THREE.FogExp2(0x000000, 0.0009);
                projector = new THREE.Projector();
				var geometry = new THREE.Geometry();
                
                var colors = [];
                geometry.colors = colors;
				for (var i = 0, l = 10000; i < l; ++i) {
					geometry.vertices.push(new THREE.Vertex(new THREE.Vector3(0, 10000, 0)));
                    colors[i] = new THREE.Color(0xffffff);
                    colors[i].setHSV((i+1000)/10000, 1.0, 1.0);
				}
				var material = new THREE.ParticleBasicMaterial({color: 0xFFFFFF, size: 64, map: THREE.ImageUtils.loadTexture('particle.png'), blending: THREE.AdditiveBlending, transparent: true, vertexColors: true});
				material.color.setHSV(1.0, 0.2, 0.8);
				particles = new THREE.ParticleSystem(geometry, material);
				particles.sortParticles = true;
				particles.updateMatrix();
				scene.add(particles);
                
                var plane = new THREE.Mesh(new THREE.PlaneGeometry(2000, 2000, 20, 20), new THREE.MeshBasicMaterial({color: 0x555555, wireframe: true}));
                plane.rotation.x = -Math.PI/2;
                scene.add(plane); 
				
				renderer = new THREE.WebGLRenderer({ clearAlpha: true, antialias: true });
                //renderer.setClearColor(new THREE.Color(0, 1));
				renderer.setSize(window.innerWidth, window.innerHeight);
				container.appendChild(renderer.domElement);
				
                stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				container.appendChild(stats.domElement);
                
                mouse2D = new THREE.Vector3(0, 10000, 0.5);
				document.addEventListener('mousemove', onMouseMove, false);
				document.addEventListener('mousedown', onMouseDown, false);
				document.addEventListener('mouseup', onMouseUp, false);
                document.addEventListener('keydown', onKeyDown, false);
                document.addEventListener('keyup', onKeyUp, false);
				window.addEventListener('resize', onWindowResize, false);

				animate();
			}
			
			function onMouseMove(event) {
                mouse2D.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse2D.y = -(event.clientY / window.innerHeight) * 2 + 1;
                if (!input.mouseDown) return;
                var ray = projector.pickingRay(mouse2D.clone(), camera);
                var intersects = ray.intersectScene(scene);
                if (intersects.length > 0) {
                    var intersector = getRealIntersector(intersects);
                    if (intersector) {
                        var s = [];
                        for (var i = 0; i < particlesPerBatch; ++i) {
                            var v = particles.geometry.vertices[roundRobin];
                            roundRobin = roundRobin < 9999 ? roundRobin + 1 : 0;
                            v.position.x = intersector.point.x + Math.random() * 5;
                            v.position.y = 0;
                            v.position.z = intersector.point.z + Math.random() * 5;
                            s.push([v.position.x, v.position.z]);
                        }
                        socket.emit('p', s);
                    }
                }
			}

            function plot(data) {
                for (var i = 0, l = Math.min(particlesPerBatch, data.length); i < l; ++i) {
                    var v = particles.geometry.vertices[roundRobin];
                    roundRobin = roundRobin < 9999 ? roundRobin + 1 : 0;
                    try {
                        v.position.x = data[i][0];
                        v.position.y = 0;
                        v.position.z = data[i][1];
                    } 
                    catch(e) {}
                }
            }
            socket.on('p', plot);

            function onMouseDown() {
                input.mouseDown = true; 
            }

            function onMouseUp() {
                input.mouseDown = false; 
            }

            function onKeyDown(event) {
                if (event.which == 39) input.right = true;
                else if (event.which == 37) input.left = true;
                else if (event.which == 40) input.down = true;
                else if (event.which == 38) input.up = true;
                else if (event.which == 16) input.shift = true;
            }

            function onKeyUp(event) {
                if (event.which == 39) input.right = false;
                else if (event.which == 37) input.left = false;
                else if (event.which == 40) input.down = false;
                else if (event.which == 38) input.up = false;
                else if (event.which == 16) input.shift = false;
            }

			function onWindowResize(event) {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize(window.innerWidth, window.innerHeight);
			}

			function animate() {
				requestAnimationFrame(animate);
				render();
				stats.update();
			}

            function getRealIntersector(intersects) {
                for(i = 0; i < intersects.length; i++) {
                    var intersector = intersects[i];
                    return intersector;
                }
                return null;
            }

            function processKeys() {
                if (input.up == true) {
                    if (input.shift) {
                        if (lookVector.z <= 1000) lookVector.z += 100;
                    }
                    else if (spinRadius > 100) spinRadius -= 100;
                }
                else if (input.down == true) {
                    if (input.shift) {
                        if (lookVector.z >= -1000) lookVector.z -= 100;
                    }
                    else spinRadius += 100;
                }
                if (input.right == true) {
                    if (input.shift) {
                        if (lookVector.x <= 1000) lookVector.x += 100;
                    }
                    else ay += .1;
                }
                else if (input.left == true) {
                    if (input.shift) {
                        if (lookVector.x >= -1000) lookVector.x -= 100;
                    }
                    else ay -= .1;
                }
            }

			function render() {
                processKeys();
                var radius = Math.sin(ax) * spinRadius;
                cameraTarget.x += (lookVector.x - cameraTarget.x) * 0.05;
                cameraTarget.z += (lookVector.z - cameraTarget.z) * 0.05;
				camera.position.x += (cameraTarget.x + Math.sin(ay) * radius - camera.position.x) * 0.05;
				camera.position.z += (cameraTarget.z + Math.cos(ay) * radius - camera.position.z) * 0.05;
				camera.position.y += (Math.cos(ax) * spinRadius - camera.position.y) * 0.05;
                camera.lookAt(cameraTarget);
                for (var i = 0, l = particles.geometry.vertices.length; i < l; ++i) {
                    var p = particles.geometry.vertices[i];
                    if (p.position.y < 10000) {
                        p.position.x += Math.random() * 3;
                        p.position.z += Math.random() * 3;
                        p.position.y += Math.random() * 3;
                    }
                }
                particles.geometry.__dirtyVertices = true;
				renderer.render(scene, camera);
			}
		</script>
	</head>
	<body onload="init();">
		<div id="info"></div>
        <div id="notice">Draw on the grid, please.</div>
        <div id="keys">
            Multiple users may be active.<br/>
            Rotate View: Left and right arrows.<br/>
            Zoom: Up and down arrows.<br/>
            Move: Shift + arrow keys.<br/>
            Paint: Press mouse + drag.<br/>
        </div>
        <a href="http://github.com/einaros/shared-particles"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://a248.e.akamai.net/assets.github.com/img/4c7dc970b89fd04b81c8e221ba88ff99a06c6b61/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f77686974655f6666666666662e706e67" alt="Fork me on GitHub"></a>
        <script type="text/javascript">
        var sc_project=6230998; 
        var sc_invisible=1; 
        var sc_security="2d430983"; 
        </script>
        <script type="text/javascript" src="http://www.statcounter.com/counter/counter.js"></script>
	</body>
</html>
